name: ðŸš€ Deploy to QA (Docker)

on:
  push:
    branches: [main]

jobs:
  build-and-ship:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build project
        run: yarn build

      - name: Build Docker image
        run: |
          docker build -t ai-mcp:latest .

      - name: Save Docker image to .tar.gz
        run: |
          docker save ai-mcp:latest | gzip > ai-mcp.tar.gz

      - name: Upload Docker image as artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-qa
          path: ai-mcp.tar.gz
          retention-days: 1 # ÐÐ²Ñ‚Ð¾Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· Ð´ÐµÐ½ÑŒ

  deploy-qa:
    needs: build-and-ship
    runs-on: ubuntu-latest
    environment: qa # Ð”Ð»Ñ Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹ Ð¸ Ð°ÑƒÐ´Ð¸Ñ‚Ð° (Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ approval)

    steps:
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-qa
          path: ./tmp

      - name: Deploy to QA server via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.QA_HOST }}
          username: ${{ secrets.QA_USER }}
          key: ${{ secrets.QA_SSH_KEY }}
          port: ${{ secrets.QA_PORT }}
          script: |
            set -e
            cd /opt/ai-mcp

            echo "ðŸ“¥ Cleaning up old files..."
            rm -f ./tmp/ai-mcp.tar.gz.b64

            echo "ðŸ“¦ Encoding new image..."
            cat > ./tmp/ai-mcp.tar.gz.b64 << 'EOF'
            $(base64 < "./tmp/ai-mcp.tar.gz")
            EOF

            echo "ðŸ“¦ Decoding and loading Docker image..."
            base64 -d ./tmp/ai-mcp.tar.gz.b64 | gunzip | docker load
            rm -f ./tmp/ai-mcp.tar.gz.b64

            echo "ðŸ§¹ Stopping and removing old container..."
            docker stop ai-mcp || true
            docker rm ai-mcp || true

            echo "ðŸš€ Running new container..."
            docker run -d \
              --name ai-mcp \
              --restart unless-stopped \
              -p 3000:3000 \
              -e NODE_ENV=qa \
              -e DEBUG=true \
              ai-mcp:latest

            echo "âœ… Deployment to QA successful!"
